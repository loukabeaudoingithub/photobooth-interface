<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Photobooth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    @keyframes slideIn {
  from { transform: translateY(-40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

h1, h2 {
  animation: slideIn 0.6s ease;
}
    body, h1, h2, p, ul, li, input, button {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      background-image: radial-gradient(circle at center, #111 0%, #000 100%);
      color: #fff;
      text-align: center;
      overflow: hidden;
    }

    .screen {
      display: none;
      padding: 60px 20px;
      height: 100vh;
      width: 100vw;
      position: absolute;
      top: 0;
      left: 0;
      backdrop-filter: blur(6px);
      background-color: rgba(0, 0, 0, 0.7);
      opacity: 0;
      transform: scale(0.98);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .screen.active {
      display: block;
      opacity: 1;
      transform: scale(1);
    }

    h1, h2 {
      font-size: 5em;
      margin-bottom: 30px;
      text-shadow: 2px 2px 8px rgba(255,255,255,0.2);
    }

    p, li {
      font-size: 1.6em;
      margin-top: 15px;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    button {
      background: linear-gradient(135deg, #ffd700, #ffcc00);
      border: none;
      color: #222;
      font-size: 1.8em;
      padding: 20px 40px;
      margin-top: 30px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.9);
    }

    a {
      color: #ffd700;
      text-decoration: underline;
      font-size: 1.4em;
    }

    input[type="text"] {
      padding: 16px;
      font-size: 1.6em;
      width: 80%;
      max-width: 500px;
      margin-top: 20px;
      border-radius: 10px;
      border: none;
    }

    #countdown {
      font-size: 7em;
      font-weight: bold;
      margin: 40px 0;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }

    .flash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      animation: flashAnim 0.3s ease;
    }

    @keyframes flashAnim {
      0% { opacity: 0.8; }
      100% { opacity: 0; }
    }

    #previewContainer {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 30px;
    }

    #previewContainer img {
      width: 40%;
      max-width: 400px;
      border: 4px solid #fff;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.7);
    }
    @keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.fade-in {
  animation: fadeIn 0.8s ease;
}
  </style>
</head>
<body>

<!-- Accueil -->
<div id="screen-home" class="screen active">
  <h1>üì∏ Bienvenue au Photobooth</h1>
  <p style="font-size:2.1em; margin-top:10px;">Cr√©ez des souvenirs inoubliables avec votre groupe!</p>
  <p style="font-size:1.8em; margin-top:10px;">Plus de <strong>156 groupes</strong> ont d√©j√† particip√© üéâ</p>

  <div style="margin:30px 0;">
    <p style="font-size:1.9em;">üë• Rejoignez la f√™te, souriez, et repartez avec vos clich√©s!</p>
    <p style="font-size:1.7em;">üì∫ Vos photos seront disponibles pr√®s de la TV √† la fin</p>
  </div>

  <button onclick="goTo('instructions')">Commencer</button>
<button id="fullscreenToggle" title="Plein √©cran" style="
  position: fixed;
  bottom: 200px;
  right: 20px;
  background-color: transparent;
  color: #ffffff;
  border: 1px solid #ffffff00;
  border-radius: 0%;
  width: 0px;
  height: 0px;
  font-size: 1.2em;
  cursor: pointer;
  z-index: 999;
  opacity: 0;
  transition: opacity 0.3s ease;
">
  ‚õ∂
</button>
  <div style="margin-top:40px;">
    <h2 style="font-size:1.6em;">Aper√ßu des derniers groupes :</h2>
    <div id="groupPreview" style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-top:20px;"></div>
  </div>

  <p style="margin-top:40px;"><a href="#" onclick="goTo('instructions')">Comment √ßa marche</a></p>
</div>

  <!-- Instructions -->
  <div id="screen-instructions" class="screen">
    <h2>Comment √ßa marche</h2>
    <ul style="text-align:center; max-width:600px; margin:auto;">
      <li>Entrez le nom de votre groupe</li>
      <li>3 photos seront prises avec un d√©compte de 5 secondes chacune</li>
      <li>Vous pourrez voir les photos √† la fin</li>
      <li>Allez les chercher √† c√¥t√©, pr√®s de la TV üì∫</li>
    </ul>
    <button onclick="goTo('group')">Suivant</button>
  </div>

  <!-- Nom du groupe -->
  <div id="screen-group" class="screen">
    <h2>Nom du groupe</h2>
    <input type="text" id="groupName" placeholder="Entrez le nom du groupe">
    <p>‚ö†Ô∏è Retenez bien ce nom pour r√©cup√©rer vos photos!</p>
    <button onclick="goTo('preview-live')">Continuer</button>
  </div>

  <!-- Preview live -->
  <div id="screen-preview-live" class="screen">
    <h2>Pr√©visualisation en direct</h2>
    <img id="ipCamFeed" src="http://10.0.0.24:8080/video" style="max-width:950px; border: 4px solid #fff; border-radius: 12px;">
    <p style="margin-top:20px;">Si la cam√©ra ne s'affiche pas, assurez-vous que l'app IP Webcam est bien lanc√©e sur le cellulaire.</p>
    <button onclick="startSession()">C'est bon, on est pr√™ts!</button>
  </div>

 <!-- S√©ance photo -->
<div id="screen-photo" class="screen">
  <h2>Pr√©parez-vous!</h2>
  <img src="http://10.0.0.24:8080/video" style="max-width:950px; border: 4px solid #fff; border-radius: 12px;">
  <div id="countdown">5</div>
  <p id="photoStatus"></p>
</div>

  <!-- Pr√©visualisation -->
  <div id="screen-preview" class="screen">
    <h2>Vos photos</h2>
    <div id="previewContainer"></div>
    <button onclick="goTo('home')">Terminer</button>
    <p>Allez chercher vos photos √† c√¥t√©, pr√®s de la TV üì∫</p>
    
    <div id="groupPreview" style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-top:20px;"></div>

<script>

  function goTo(screen) {
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.remove('active');
      s.style.opacity = 0;
      s.style.transform = 'scale(0.98)';
    });
    const target = document.getElementById('screen-' + screen);
    target.classList.add('active');
    setTimeout(() => {
      target.style.opacity = 1;
      target.style.transform = 'scale(1)';
    }, 50);
  }

  let currentPhoto = 1;
  let groupName = "";
  const SERVER_URL = "http://10.0.0.46:5001";
  let liveStream = null;

  function goTo(screen) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + screen).classList.add('active');

    if (screen === 'group') {
      document.getElementById("groupName").value = "";
    }

    if (screen === 'preview-live') {
      const video = document.getElementById("liveVideo");
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
        .then(stream => {
          liveStream = stream;
          video.srcObject = stream;
        })
        .catch(err => {
          alert("Impossible d'acc√©der √† la cam√©ra : " + err);
        });
    }

    if (screen !== 'preview-live' && screen !== 'photo' && liveStream) {
      liveStream.getTracks().forEach(track => track.stop());
      liveStream = null;
      const video1 = document.getElementById("liveVideo");
      const video2 = document.getElementById("liveDuringPhoto");
      if (video1) video1.srcObject = null;
      if (video2) video2.srcObject = null;
    }
  }

  function startSession() {
    groupName = document.getElementById("groupName").value.trim();
    if (!groupName) {
      alert("Veuillez entrer un nom de groupe.");
      return;
    }

    fetch(`${SERVER_URL}/start-session?group=${encodeURIComponent(groupName)}`, { method: "POST" });

    const video = document.getElementById("liveDuringPhoto");
    if (liveStream) {
      video.srcObject = liveStream;
    }

    goTo('photo');
    startCountdown(currentPhoto);
  }

  function startCountdown(photoIndex) {
  let count = 5;
  const countdown = document.getElementById("countdown");
  const status = document.getElementById("photoStatus");
  countdown.textContent = count;
  status.textContent = `Photo ${photoIndex} dans...`;

  let flashDone = false;
  let captureSent = false;

  const interval = setInterval(() => {
    if (count > 0) {
      countdown.textContent = count;
    } else {
      countdown.textContent = "Souriez!";
    }

    if (count === 4 && !captureSent) {
      captureSent = true;
      status.textContent = `üì∏ Photo ${photoIndex} en cours...`;
      fetch(`${SERVER_URL}/take-photo?index=${photoIndex}&group=${encodeURIComponent(groupName)}`, { method: "POST" });
    }

    if (count === 0 && !flashDone) {
      flashDone = true;
      triggerFlash();
    }

    if (count < 0) {
      clearInterval(interval);
      status.textContent = `‚úÖ Photo ${photoIndex} prise!`;

      if (photoIndex < 3) {
        currentPhoto++;
        setTimeout(() => startCountdown(currentPhoto), 1500);
      } else {
        setTimeout(() => showPreview(2000), 3000);
      }
    }

    count--;
  }, 1000);
}

      function triggerFlash() {
        const flash = document.createElement("div");
        flash.className = "flash";
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 300);
      }

      function setImgWithRetry(img, baseSrc, tries = 6, delayMs = 600) {
        let attempt = 0;
        const tryLoad = () => {
          const url = `${baseSrc}?t=${Date.now()}`;
          img.onerror = () => {
            attempt++;
            if (attempt < tries) {
              setTimeout(tryLoad, delayMs);
            }
          };
          img.src = url;
        };
        tryLoad();
      }

      function showPreview(delayExtraMs = 0) {
        const container = document.getElementById("previewContainer");
        container.innerHTML = "";

        const loadImages = () => {
          goTo('preview');
          for (let i = 1; i <= 3; i++) {
            const img = document.createElement("img");
            setImgWithRetry(img, `${SERVER_URL}/photo/${encodeURIComponent(groupName)}/photo${i}.jpg`, 6, 700);
            container.appendChild(img);
          }
          currentPhoto = 1;
        };

        if (delayExtraMs > 0) {
          setTimeout(loadImages, delayExtraMs);
        } else {
          loadImages();
        }
      }
      function requestCamera() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("La cam√©ra n'est pas disponible sur ce navigateur ou cette connexion. Essayez via Chrome ou une connexion s√©curis√©e.");
    return;
  }

  const video = document.getElementById("liveVideo");
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
    .then(stream => {
      liveStream = stream;
      video.srcObject = stream;
    })
    .catch(err => {
      alert("Impossible d'acc√©der √† la cam√©ra : " + err);
    });
}
fetch('/random-group-photos')
  .then(res => res.json())
  .then(images => {
    const container = document.getElementById('groupPreview');
    container.innerHTML = '';
    images.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.style.borderRadius = '8px';
      img.style.border = '2px solid #fff';
      img.style.width = '150px';
      img.style.height = '100px';
      img.style.objectFit = 'cover';
      container.appendChild(img);
    });
  });


function loadPhotos() {
  fetch('/random-group-photos')
    .then(res => res.json())
    .then(images => {
      const container = document.getElementById('groupPreview');
      container.innerHTML = '';
      images.forEach(src => {
        const img = document.createElement('img');
        img.src = src + '?t=' + new Date().getTime(); // √©vite le cache
        img.alt = "Photo";
        img.classList.add('fade-in');
        img.style.borderRadius = '8px';
        img.style.border = '2px solid #fff';
        img.style.width = '300px';
        img.style.height = '200px';
        img.style.objectFit = 'cover';
        container.appendChild(img);
      });
    });
}

loadPhotos(); // premi√®re fois
setInterval(loadPhotos, 5000); // toutes les 10 secondes


document.getElementById('fullscreenToggle').addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      alert(`Erreur plein √©cran : ${err.message}`);
    });
  } else {
    document.exitFullscreen();
  }
});

    </script>
    
  </body>
</html>